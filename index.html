<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>NeuRecovery</title>
  <link rel="icon" type="image/png" href="logo.png">
  <link rel="apple-touch-icon" href="logo.png">
  <meta name="theme-color" content="#0f172a">
  <link rel="manifest" href="manifest.json">

  <style>
    :root {
      --bg: #0f172a;
      --card: rgba(30, 41, 59, 0.7);
      --text: #f8fafc;
      --muted: #94a3b8;
      --accent: #38bdf8;
      --danger: #fb7185;
      --success: #34d399;
      --glass-border: rgba(255, 255, 255, 0.1);
      --gradient-bg: linear-gradient(135deg, #0f172a 0%, #1e1b4b 100%);
    }

    body.ultra {
      --bg: #020617;
      --card: rgba(15, 23, 42, 0.8);
      --gradient-bg: linear-gradient(180deg, #020617 0%, #000000 100%);
      --accent: #818cf8;
    }

    * { box-sizing: border-box; font-family: 'Inter', system-ui, -apple-system, sans-serif; -webkit-tap-highlight-color: transparent; }

    body {
      margin: 0; background: var(--gradient-bg); background-attachment: fixed;
      color: var(--text); min-height: 100vh; padding: 20px 16px 120px 16px;
      transition: background 0.4s ease; overflow-x: hidden; text-rendering: optimizeLegibility;
    }

    .container { max-width: 450px; margin: auto; }

    /* --- ANIMATION --- */
    @keyframes revealCard {
      0% { opacity: 0; transform: translateY(20px); }
      100% { opacity: 1; transform: translateY(0); }
    }
    .reveal { opacity: 0; will-change: transform, opacity; }
    .reveal.active { animation: revealCard 0.6s cubic-bezier(0.22, 1, 0.36, 1) forwards; }
    .delay-1 { animation-delay: 0.1s; } .delay-2 { animation-delay: 0.2s; }
    .delay-3 { animation-delay: 0.3s; } .delay-4 { animation-delay: 0.4s; }
    .delay-5 { animation-delay: 0.5s; }

    /* --- UI COMPONENTS --- */
    .card {
      background: var(--card); backdrop-filter: blur(12px) saturate(180%);
      -webkit-backdrop-filter: blur(12px) saturate(180%);
      border: 1px solid var(--glass-border); border-radius: 24px;
      padding: 24px; margin-bottom: 20px; box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.3);
    }

    h1 { font-size: 1.5rem; font-weight: 700; margin-bottom: 4px; }
    h2 { font-size: 1.1rem; font-weight: 600; color: var(--muted); margin-bottom: 16px; }

    button {
      width: 100%; padding: 16px; border-radius: 16px; border: none;
      background: var(--accent); color: #0f172a; font-size: 16px; font-weight: 700;
      cursor: pointer; transition: 0.2s;
    }
    button:active { transform: scale(0.96); }
    button.secondary { background: rgba(255, 255, 255, 0.05); color: var(--text); border: 1px solid var(--glass-border); }
    button.danger-outline { background: rgba(251, 113, 133, 0.1); color: var(--danger); border: 1px solid var(--danger); }

    .counter {
      font-size: 48px; font-weight: 800; text-align: center;
      background: linear-gradient(to right, #fff, var(--accent));
      -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin: 10px 0;
    }

    .intro {
      position: fixed; inset: 0; z-index: 9999; background: #0f172a;
      display: flex; flex-direction: column; justify-content: center; align-items: center; transition: opacity 0.8s ease;
    }
    .intro h1 { font-size: 2.5rem; background: linear-gradient(to bottom, #fff, #64748b); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }

    /* --- STATS & CALENDAR --- */
    .stats-nav { display: flex; gap: 8px; margin-bottom: 20px; background: rgba(0,0,0,0.2); padding: 4px; border-radius: 12px; }
    .stats-btn { flex: 1; padding: 10px; font-size: 11px; border-radius: 8px; border: none; background: transparent; color: var(--muted); cursor: pointer; font-weight: 600; }
    .stats-btn.active { background: var(--card); color: var(--accent); border: 1px solid var(--glass-border); }
    .stats-content { display: none; padding: 10px 0; animation: fadeIn 0.3s ease; }
    .stats-content.active { display: block; }
    .stat-line { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.05); font-size: 14px; }

    .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; margin-top: 15px; }
    .calendar-label { font-size: 10px; color: var(--muted); font-weight: 700; text-align: center; margin-bottom: 5px; }
    .cal-day { aspect-ratio: 1/1; display: flex; align-items: center; justify-content: center; font-size: 12px; border-radius: 50%; transition: 0.3s; }
    .cal-active { border: 1.5px solid var(--accent); color: var(--accent); font-weight: 700; }
    .cal-relapse { border: 1.5px solid var(--danger); color: var(--danger); font-weight: 700; }

    .bottom-nav {
      position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
      width: calc(100% - 32px); max-width: 400px; background: rgba(15, 23, 42, 0.8);
      backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
      border: 1px solid var(--glass-border); border-radius: 28px;
      display: flex; justify-content: space-around; align-items: center; padding: 12px 10px; z-index: 2000;
      box-shadow: 0 20px 40px rgba(0,0,0,0.4);
    }
    .nav-item { display: flex; flex-direction: column; align-items: center; color: var(--muted); cursor: pointer; transition: 0.3s; flex: 1; }
    .nav-item.active { color: var(--accent); }
    .nav-item svg { width: 24px; height: 24px; margin-bottom: 4px; }

    .page { display: none; animation: fadeIn 0.4s ease; }
    .page.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    .log-item { display: flex; justify-content: space-between; align-items: center; padding: 12px; border-radius: 14px; background: rgba(255,255,255,0.03); border-left: 4px solid var(--muted); margin-bottom: 8px; font-size: 13px; }
    .log-item.muncul { border-left-color: var(--danger); }
    .log-item.mereda { border-left-color: var(--success); }
    .modal { position: fixed; inset: 0; background: var(--bg); z-index: 3000; padding: 20px; display: none; overflow-y: auto; }
    
    .theme-switcher { display: flex; gap: 8px; margin-bottom: 24px; background: rgba(0,0,0,0.2); padding: 4px; border-radius: 12px; }
    .theme-btn { flex: 1; padding: 8px; font-size: 12px; border-radius: 8px; border: none; background: transparent; color: var(--muted); cursor: pointer; }
    .theme-btn.active { background: var(--card); color: var(--accent); }
  </style>
</head>
<body>

<div id="intro" class="intro">
  <h1>NeuRecovery</h1>
  <p style="color:var(--accent)">Mind over Matter</p>
</div>

<nav class="bottom-nav">
  <div class="nav-item active" onclick="switchPage('home', this)">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
  </div>
  <div class="nav-item" onclick="switchPage('insights', this)">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline></svg>
  </div>
  <div class="nav-item" onclick="switchPage('toolbox', this)">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"></path></svg>
  </div>
  <div class="nav-item" onclick="switchPage('profile', this)">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
  </div>
</nav>

<div id="historyModal" class="modal">
  <div class="container">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
      <h1>Riwayat Lengkap</h1>
      <button onclick="closeHistory()" class="secondary" style="width: auto; padding: 8px 16px;">Tutup</button>
    </div>
    <div id="fullHistoryList"></div>
  </div>
</div>

<div id="app" style="display:none;">
  <div class="container">

    <section id="home" class="page active">
      <div class="reveal active delay-1" style="text-align: center; margin-bottom: 30px; margin-top: 10px;">
        <h1>NeuRecovery</h1>
        <p id="userGreeting" style="color:var(--muted)">Small decision matter.</p>
      </div>

      <div class="card reveal active delay-2" style="text-align: center;">
        <h2>Streak</h2>
        <div class="counter" id="dayCounter">0</div>
        <p style="font-size: 14px; color: var(--muted)">Days without relapse</p>
      </div>

      <div class="card reveal active delay-3">
        <h2>Check-in</h2>
        <button id="btnCheckin" onclick="checkIn()">Check-in</button>
        <p id="checkinStatus" style="font-size: 13px; text-align: center; margin-top: 10px;"></p>
      </div>

      <div class="card reveal active delay-4">
        <h2 style="color: var(--danger)">Relapse?</h2>
        <button class="danger-outline" onclick="triggerRelapse()">Reset Streak</button>
      </div>

      <div class="card reveal active delay-5" style="text-align: center;">
        <h1 id="clockDisplay" style="font-size: 2.5rem; margin-bottom: 8px;">00:00:00</h1>
        <p id="dateDisplay" style="color: var(--muted); font-size: 14px; font-weight: 500;"></p>
      </div>
    </section>

    <section id="insights" class="page">
      <h1>Insights</h1>
      <div class="card">
        <h2>Urge Tracker</h2>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
          <button style="background: rgba(251, 113, 133, 0.15); color: var(--danger); border: 1px solid var(--danger);" onclick="logUrge('muncul')">Emerge</button>
          <button style="background: rgba(52, 211, 153, 0.15); color: var(--success); border: 1px solid var(--success);" onclick="logUrge('mereda')">Recede</button>
        </div>
        <div id="urgeLogList" style="margin-top: 20px;"></div>
        <div style="display: flex; justify-content: center; gap: 15px; margin-top: 15px;">
          <button onclick="showHistory()" style="background: transparent; color: var(--muted); text-decoration: underline; width: auto; font-size: 12px; border:none; cursor:pointer;">Show All</button>
          <button onclick="clearUrgeHistory()" style="background: transparent; color: var(--danger); text-decoration: underline; width: auto; font-size: 12px; border:none; cursor:pointer;">Clear</button>
        </div>
      </div>
      
      <div class="card">
        <h2>Statistic</h2>
        <div class="stats-nav">
            <button class="stats-btn active" onclick="switchStats('harian', this)">Daily</button>
            <button class="stats-btn" onclick="switchStats('mingguan', this)">Weekly</button>
            <button class="stats-btn" onclick="switchStats('bulanan', this)">Monthly</button>
        </div>
        <div id="stats-harian" class="stats-content active">
            <div class="stat-line"><span>Urge emerging today</span><span id="s-d-muncul">0</span></div>
            <div class="stat-line"><span>Urge receding today</span><span id="s-d-mereda">0</span></div>
        </div>
        <div id="stats-mingguan" class="stats-content">
            <div class="stat-line"><span>Total Urge (7 days)</span><span id="s-w-total">0</span></div>
        </div>
        <div id="stats-bulanan" class="stats-content">
            <div class="stat-line"><span>Total Urge This Month</span><span id="s-m-total">0</span></div>
        </div>
      </div>

      <div class="card">
        <h2 id="calMonthName">Calendar</h2>
        <div class="calendar-grid" id="mainCalendar"></div>
      </div>
    </section>

    <section id="toolbox" class="page">
      <h1>Toolbox</h1>
      <div class="card" style="border: 2px solid var(--danger);">
        <h2 style="color: var(--danger)">SOS Mode</h2>
        <p style="font-size: 13px; color: var(--muted); margin-bottom: 15px;">Use it when the urge is unbearable.</p>
        <button style="background: var(--danger); color: white;" onclick="activatePanic()">Activate Help</button>
      </div>

      <div class="card" id="panicMode" style="display:none; background: rgba(0,0,0,0.4);">
        <h2 style="color: white">Bernapaslah...</h2>
        <p id="panicText" style="color: white">Tarik napas dalam 4 detik, tahan, buang pelan.</p>
        <div class="counter" id="breathCounter" style="color: var(--danger);">30</div>
        <button class="secondary" onclick="exitPanic()">Sudah Lebih Baik</button>
      </div>

      <div class="card">
        <h2>Dr. Tirta Method</h2>
        <ul style="font-size: 12px; color: var(--muted); padding-left: 20px;">
          <li>5 things you see.</li><li>4 things you can touch.</li><li>3 sounds you hear.</li><li>2 smells you can perceive.</li><li>1 taste you can feel.</li>
        </ul>
      </div>
    </section>

    <section id="profile" class="page">
      <h1>Settings & Profile</h1>
      
      <div id="loginCard" class="card">
        <h2>Cloud Sync</h2>
        <button id="btnLogin" style="background:white; color:black; display:flex; align-items:center; justify-content:center; gap:10px;">
          <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" width="18"> Login with Google
        </button>
      </div>
      <div id="userCard" class="card" style="display:none; text-align:center;">
        <img id="userPhoto" src="" style="width:50px; border-radius:50%; margin-bottom:10px;">
        <h2 id="userName">User</h2>
        <button class="secondary" id="btnLogout" style="padding:8px; font-size:12px;">Sign Out</button>
      </div>

      <div class="theme-switcher">
        <button class="theme-btn active" id="btnDark" onclick="setTheme('dark')">Dark</button>
        <button class="theme-btn" id="btnUltra" onclick="setTheme('ultra')">Ultra Dark</button>
      </div>

      <div class="card">
        <h2>Data Management</h2>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
          <button class="secondary" onclick="exportData()">Backup</button>
          <button class="secondary" onclick="importData()">Restore</button>
        </div>
        <input type="file" id="fileInput" style="display:none;" />
      </div>
    </section>

  </div>
</div>

<script type="module">
  // --- FIREBASE SDK ---
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
  import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDzI8YTl2AXPbaVZ8xR0ZfTzYqMhgJx1E0",
    authDomain: "neurecovery.firebaseapp.com",
    projectId: "neurecovery",
    storageBucket: "neurecovery.firebasestorage.app",
    messagingSenderId: "484147062782",
    appId: "1:484147062782:web:52210c407da5226d6d82af",
    measurementId: "G-DYQNVYWKYZ"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const provider = new GoogleAuthProvider();

  // --- APP STATE ---
  let currentUser = null;
  let userData = {
    startDate: localStorage.getItem("startDate") || null,
    lastCheckinDate: localStorage.getItem("lastCheckinDate") || null,
    urges: JSON.parse(localStorage.getItem("urges")) || [],
    relapseHistory: JSON.parse(localStorage.getItem("relapseHistory")) || []
  };

  // --- AUTH LOGIC ---
  onAuthStateChanged(auth, async (user) => {
    if (user) {
      currentUser = user;
      document.getElementById('loginCard').style.display = 'none';
      document.getElementById('userCard').style.display = 'block';
      document.getElementById('userName').innerText = user.displayName;
      document.getElementById('userPhoto').src = user.photoURL;
      document.getElementById('userGreeting').innerText = `Mind over matter, ${user.displayName.split(' ')[0]}!`;

      const docSnap = await getDoc(doc(db, "users", user.uid));
      if (docSnap.exists()) {
        userData = docSnap.data();
        saveLocal();
      } else {
        await syncToCloud();
      }
    } else {
      currentUser = null;
      document.getElementById('loginCard').style.display = 'block';
      document.getElementById('userCard').style.display = 'none';
      document.getElementById('userGreeting').innerText = "Small decisions matter.";
    }
    updateDisplay(); renderUrges(); renderCalendar(); updateStatsUI();
  });

  window.loginGoogle = () => signInWithPopup(auth, provider);
  document.getElementById('btnLogin').onclick = window.loginGoogle;
  document.getElementById('btnLogout').onclick = () => auth.signOut();

  async function syncToCloud() {
    if (currentUser) await setDoc(doc(db, "users", currentUser.uid), userData);
  }

  function saveLocal() {
    localStorage.setItem("startDate", userData.startDate || "");
    localStorage.setItem("lastCheckinDate", userData.lastCheckinDate || "");
    localStorage.setItem("urges", JSON.stringify(userData.urges));
    localStorage.setItem("relapseHistory", JSON.stringify(userData.relapseHistory));
  }

  // --- CLOCK ---
  function updateClock() {
    const now = new Date();
    const wibTime = new Date(now.getTime() + (now.getTimezoneOffset() * 60000) + (7 * 3600000));
    const h = String(wibTime.getHours()).padStart(2, '0');
    const m = String(wibTime.getMinutes()).padStart(2, '0');
    const s = String(wibTime.getSeconds()).padStart(2, '0');
    const dd = String(wibTime.getDate()).padStart(2, '0');
    const mm = String(wibTime.getMonth() + 1).padStart(2, '0');
    const yy = String(wibTime.getFullYear()).slice(-2);
    const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
    document.getElementById('clockDisplay').innerText = `${h}:${m}:${s}`;
    document.getElementById('dateDisplay').innerText = `${days[wibTime.getDay()]}, ${dd}/${mm}/${yy}`;
  }
  setInterval(updateClock, 1000);

  // --- CORE LOGIC ---
  function getTodayString() {
    const now = new Date();
    const wib = new Date(now.getTime() + (now.getTimezoneOffset() * 60000) + (7 * 3600000));
    return wib.toISOString().split('T')[0];
  }

  window.checkIn = async () => {
    const today = getTodayString();
    if (!userData.startDate) userData.startDate = today;
    userData.lastCheckinDate = today;
    saveLocal();
    await syncToCloud();
    updateDisplay();
  };

  window.triggerRelapse = async () => {
    if (confirm("Reset streak?")) {
      userData.relapseHistory.push(getTodayString());
      userData.startDate = null;
      userData.lastCheckinDate = null;
      saveLocal();
      await syncToCloud();
      updateDisplay();
      renderCalendar();
    }
  };

  window.logUrge = async (status) => {
    const now = new Date();
    userData.urges.unshift({
      status,
      date: now.toLocaleDateString('id-ID', { day: 'numeric', month: 'short' }),
      time: now.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' })
    });
    if (userData.urges.length > 50) userData.urges.pop();
    saveLocal();
    await syncToCloud();
    renderUrges();
    updateStatsUI();
  };

  // --- UI RENDERING ---
  function updateDisplay() {
    const today = getTodayString();
    const counter = document.getElementById('dayCounter');
    const btn = document.getElementById('btnCheckin');
    const status = document.getElementById('checkinStatus');

    if (!userData.startDate) counter.innerText = "0";
    else {
      const start = new Date(userData.startDate);
      const diff = Math.round((new Date().setHours(0,0,0,0) - start.setHours(0,0,0,0)) / 86400000);
      counter.innerText = (userData.lastCheckinDate === today) ? diff + 1 : diff;
    }

    if (userData.lastCheckinDate === today) {
      btn.disabled = true; btn.style.opacity = "0.5"; btn.innerText = "Checked-in";
      status.innerText = "✓ Commitment kept."; status.style.color = "var(--success)";
    } else {
      btn.disabled = false; btn.style.opacity = "1"; btn.innerText = "Check-in";
      status.innerText = "Click to record progress."; status.style.color = "var(--muted)";
    }
  }

  function renderUrges() {
    const list = document.getElementById("urgeLogList");
    const full = document.getElementById("fullHistoryList");
    const html = u => `<div class="log-item ${u.status}"><span>${u.status==='muncul'?'⚠️ Emerge':'✅ Recede'}</span><span>${u.date} ${u.time}</span></div>`;
    list.innerHTML = userData.urges.length ? userData.urges.slice(0,3).map(html).join('') : "<p style='text-align:center; font-size:12px;'>No logs.</p>";
    full.innerHTML = userData.urges.map(html).join('');
  }

  window.updateStatsUI = () => {
    const today = new Date().toLocaleDateString('id-ID', { day: 'numeric', month: 'short' });
    document.getElementById('s-d-muncul').innerText = userData.urges.filter(u => u.date === today && u.status === 'muncul').length;
    document.getElementById('s-d-mereda').innerText = userData.urges.filter(u => u.date === today && u.status === 'mereda').length;
    document.getElementById('s-w-total').innerText = userData.urges.length;
    document.getElementById('s-m-total').innerText = userData.urges.length;
  };

window.renderCalendar = () => {
    const grid = document.getElementById('mainCalendar');
    const now = new Date();
    document.getElementById('calMonthName').innerText = now.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
    
    grid.innerHTML = ['S','M','T','W','T','F','S'].map(d => `<div class="calendar-label">${d}</div>`).join('');
    
    const first = new Date(now.getFullYear(), now.getMonth(), 1).getDay();
    const total = new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate();
    
    for (let i = 0; i < first; i++) grid.innerHTML += `<div></div>`;
    
    // Ambil string hari ini (YYYY-MM-DD)
    const todayStr = getTodayString();
    
    for (let d = 1; d <= total; d++) {
      // Manual merakit string YYYY-MM-DD supaya konsisten di semua HP
      const y = now.getFullYear();
      const m = String(now.getMonth() + 1).padStart(2, '0');
      const day = String(d).padStart(2, '0');
      const dateISO = `${y}-${m}-${day}`;
      
      let cls = "cal-day";
      
      // 1. Prioritas MERAH jika ada di riwayat relapse
      if (userData.relapseHistory && userData.relapseHistory.includes(dateISO)) {
        cls = "cal-day cal-relapse";
      } 
      // 2. Jika tidak relapse, cek apakah dalam rentang aktif (BIRU)
      else if (userData.startDate && dateISO >= userData.startDate && dateISO <= todayStr) {
        cls += " cal-active";
      }
      
      grid.innerHTML += `<div class="${cls}">${d}</div>`;
    }
  };

  // --- UTILS (NAV, THEME, PANIC, BACKUP) ---
  window.switchPage = (pageId, navEl) => {
    document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
    navEl.classList.add('active');
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    document.getElementById(pageId).classList.add('active');
    if(pageId === 'insights') { renderCalendar(); updateStatsUI(); }
  };

  window.switchStats = (type, btn) => {
    document.querySelectorAll('.stats-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    document.querySelectorAll('.stats-content').forEach(c => c.classList.remove('active'));
    document.getElementById('stats-' + type).classList.add('active');
  };

  window.setTheme = (m) => {
    document.body.className = m === 'ultra' ? 'ultra' : '';
    localStorage.setItem('theme', m);
  };
  setTheme(localStorage.getItem('theme') || 'dark');

  let pTimer;
  window.activatePanic = () => {
    document.getElementById("panicMode").style.display = "block";
    let s = 30;
    pTimer = setInterval(() => {
      s--; document.getElementById("breathCounter").innerText = s;
      if (s <= 0) { clearInterval(pTimer); document.getElementById("panicText").innerText = "Take deep breaths."; }
    }, 1000);
  };
  window.exitPanic = () => { clearInterval(pTimer); document.getElementById("panicMode").style.display = "none"; };

  window.showHistory = () => document.getElementById("historyModal").style.display = "block";
  window.closeHistory = () => document.getElementById("historyModal").style.display = "none";
  window.clearUrgeHistory = () => { if(confirm("Clear?")) { userData.urges=[]; saveLocal(); syncToCloud(); renderUrges(); updateStatsUI(); } };

  window.exportData = () => {
    const blob = new Blob([JSON.stringify(userData)], { type: "application/json" });
    const a = document.createElement("a"); a.href = URL.createObjectURL(blob); a.download = `NeuRecovery_Backup.json`; a.click();
  };
  window.importData = () => document.getElementById("fileInput").click();
  document.getElementById("fileInput").onchange = function() {
    const reader = new FileReader();
    reader.onload = async (e) => {
      userData = JSON.parse(e.target.result);
      saveLocal(); await syncToCloud(); location.reload();
    };
    reader.readAsText(this.files[0]);
  };

  setTimeout(() => {
    document.getElementById("intro").style.opacity = "0";
    setTimeout(() => {
      document.getElementById("intro").style.display = "none";
      document.getElementById("app").style.display = "block";
      document.querySelectorAll('.reveal').forEach(el => el.classList.add('active'));
      updateClock();
    }, 800);
  }, 1500);
</script>

</body>
</html>


